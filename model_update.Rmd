---
title: "Module 2"
output: html_document
date: '2022-10-10'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ISLR)
library(dplyr)
library(leaps)
library(car)
```

## Body Fat Data

```{r}
bodyfat <- read.csv('BodyFat.csv')
head(bodyfat)
```

## Step 1. Analyzing Raw Data

```{r}
head(bodyfat)
tail(bodyfat)
```

```{r}
summary(bodyfat)
```

```{r}
hist(bodyfat$AGE)
hist(bodyfat$WEIGHT)
bodyfat %>% subset(bodyfat$WEIGHT > 250)

hist(bodyfat$HEIGHT)
bodyfat %>% subset(bodyfat$HEIGHT < 50)

hist(bodyfat$BODYFAT)
hist(bodyfat$NECK)
bodyfat %>% subset(bodyfat$NECK > 50)

hist(bodyfat$CHEST)
bodyfat %>% subset(bodyfat$CHEST > 130)

hist(bodyfat$ABDOMEN)
bodyfat %>% subset(bodyfat$ABDOMEN > 140)

hist(bodyfat$HIP)
bodyfat %>% subset(bodyfat$HIP > 120) # may have to get rid of another outlier row 41

hist(bodyfat$THIGH)
bodyfat %>% subset(bodyfat$THIGH > 75)

hist(bodyfat$KNEE)
bodyfat %>% subset(bodyfat$KNEE > 4) # 244th observation

hist(bodyfat$ANKLE)
bodyfat %>% subset(bodyfat$ANKLE<= 30) # 31, 86

hist(bodyfat$BICEPS)
bodyfat %>% subset(bodyfat$BICEPS > 40)

hist(bodyfat$FOREARM)
bodyfat %>% subset(bodyfat$FOREARM < 25) # no obv outliers

hist(bodyfat$WRIST)
bodyfat %>% subset(bodyfat$WRIST > 21) # 39, 41

# most all have row 39 which is deleted bc weight is huge outlier

max(bodyfat$BODYFAT)
min(bodyfat$BODYFAT)
sort(bodyfat$BODYFAT)
```



### Clean data set
```{r}
bodyfat2 <- bodyfat %>% select(-ADIPOSITY, -IDNO, -DENSITY) %>% mutate(HEIGHT = HEIGHT * 2.54, WEIGHT = WEIGHT*2.2)
write.csv(bodyfat2, 'bodyfat2.csv')
bodyfat3 <- bodyfat %>% select(-ADIPOSITY, -IDNO, -DENSITY, -WEIGHT) %>% mutate(HEIGHT = HEIGHT * 2.54)

```

## New dataset to add to repo
```{r}
bodyfat_out <- bodyfat %>% subset(bodyfat$BODYFAT >= 4 & bodyfat$BODYFAT <= 40 & bodyfat$WEIGHT < 300 & bodyfat$HEIGHT > 50 & bodyfat$ANKLE <= 30 & bodyfat$WRIST <= 21) %>% select(-ADIPOSITY, -IDNO, -DENSITY) %>% mutate(HEIGHT = HEIGHT * 2.54, WEIGHT = WEIGHT*2.2)
```

## Modeling

UPDATED: fitting with bodyfat_out data
```{r}
lm_out <- lm(BODYFAT ~., data = bodyfat_out)
summary(lm_out)
plot(lm_out, which=4, cook.levels=cutoff)
plot(lm_out)
```

```{r}
lm_sub3 <- lm(BODYFAT ~ ABDOMEN + WRIST + WEIGHT, bodyfat_out)
summary(lm_sub3)
vif(lm_sub3)
```

Multicollinearity seems to have gotten worse.





## Old code. Will need if we go back to old model
```{r}
# bodyfat_out <- bodyfat_out[-c(42, 82, 221),]
# lm_out2 <- lm(BODYFAT ~., data = bodyfat_out)
# summary(lm_out2)
# plot(lm_out2, which=4, cook.levels=cutoff)
# plot(lm_out2)
```

Best subsets with bodyfat, weight, height outliers removed:
```{r}
models <- regsubsets(BODYFAT ~ ., bodyfat_out, nvmax = 3)
models.sum <- summary(models)
models.sum

# Create four plots within a 2x2 frame to compare the different criteria
par(mfrow = c(2,2))
 # SSE
plot(models.sum$rss, xlab = "Number of predictors", ylab = "SSE", type = "l")
 # R2
plot(models.sum$adjr2, xlab = "Number of predictors", ylab = "Adjusted RSq", type = "l")
 # Mallow's Cp
plot(models.sum$cp, xlab = "Number of predictors", ylab = "Cp", type = "l")
 # BIC
plot(models.sum$bic, xlab = "Number of predictors", ylab = "BIC", type = "l")

```

```{r}
pii = hatvalues(lm_out2)
cooki = cooks.distance(lm_out2)

par(mfrow = c(2,1))
n = dim(bodyfat_out2)[1]
plot(1:n,pii,type="p",pch=19,cex=1.2,cex.lab=1.5,cex.main=1.5,
     xlab="Index (Each Observation)",ylab="Pii",main="Leverage Values (Pii)")
plot(1:n,cooki,type="p",pch=19,cex=1.2,cex.lab=1.5,cex.main=1.5,
     xlab="Index (Each Observation)",ylab="Cook's Distance",main="Influence Values (Cook's Distance)")

```



## No outliers removed

Fitting full model:
```{r}
full_lm <- lm(BODYFAT ~ ., data = bodyfat2)
summary(full_lm)
plot(full_lm)
```

Forward stepwise? fit empty model first
```{r}
# Fit an empty model with only the response
FitStart <- lm(BODYFAT ~ 1, bodyfat2)


# Fit a full model with all predictors
FitAll <- lm(BODYFAT ~ ., bodyfat2)

# Run the stepwise regression with forward selection based on the AIC criterion
step(FitStart,direction="forward", scope = formula(FitAll))
```

```{r}
# Fit an empty model with only the response
FitStart <- lm(BODYFAT ~ 1, bodyfat3)


# Fit a full model with all predictors
FitAll <- lm(BODYFAT ~ ., bodyfat3)

# Run the stepwise regression with forward selection based on the AIC criterion
step(FitStart,direction="forward", scope = formula(FitAll))
```


```{r}
# Run the stepwise regression with backward selection based on the AIC criterion
step(FitAll, direction="backward", scope = formula(FitStart))
```

Best subsets with 4 criteria
```{r}
models <- regsubsets(BODYFAT ~ ., bodyfat2, nvmax = 3)
models.sum <- summary(models)
models.sum

# Create four plots within a 2x2 frame to compare the different criteria
par(mfrow = c(2,2))
 # SSE
plot(models.sum$rss, xlab = "Number of predictors", ylab = "SSE", type = "l")
 # R2
plot(models.sum$adjr2, xlab = "Number of predictors", ylab = "Adjusted RSq", type = "l")
 # Mallow's Cp
plot(models.sum$cp, xlab = "Number of predictors", ylab = "Cp", type = "l")
 # BIC
plot(models.sum$bic, xlab = "Number of predictors", ylab = "BIC", type = "l")
```

Without weight bodyfat3:
```{r}
models <- regsubsets(BODYFAT ~ ., bodyfat3, nvmax = 3)
models.sum <- summary(models)
models.sum

# Create four plots within a 2x2 frame to compare the different criteria
par(mfrow = c(2,2))
 # SSE
plot(models.sum$rss, xlab = "Number of predictors", ylab = "SSE", type = "l")
 # R2
plot(models.sum$adjr2, xlab = "Number of predictors", ylab = "Adjusted RSq", type = "l")
 # Mallow's Cp
plot(models.sum$cp, xlab = "Number of predictors", ylab = "Cp", type = "l")
 # BIC
plot(models.sum$bic, xlab = "Number of predictors", ylab = "BIC", type = "l")
```
```{r}
lm3 <- lm(BODYFAT ~ WRIST + ABDOMEN + HIP, bodyfat3)
summary(lm3)
vif(lm3)
```

Refit with top 3 features from best subsets:
```{r}
lm3 <- lm(BODYFAT ~ WEIGHT + ABDOMEN + WRIST, bodyfat2)
summary(lm3)
vif(lm3)
```

```{r}
lm2 <- lm(BODYFAT ~ WEIGHT + ABDOMEN, bodyfat2)
summary(lm2)

```

```{r}
lm1 <- lm(BODYFAT ~ WEIGHT, bodyfat2)
summary(lm1)
```

```{r}
lm_ab <- lm(BODYFAT ~ ABDOMEN, bodyfat2)
summary(lm_ab)
```

```{r}
lm_age <- lm(BODYFAT ~ WEIGHT + ABDOMEN, bodyfat2)
summary(lm2)
```

** AIC is difficult to interpret- how we want to interpret this number, negative value being better
** using Rsquared as secondary metric to AIC??
** issues with collinearity; VIF threshold- 15?
** negative coefficients?

## Step 4: Diagnostics
```{r}
pii = hatvalues(full_lm)
cooki = cooks.distance(full_lm)

par(mfrow = c(2,1))
n = dim(bodyfat)[1]
plot(1:n,pii,type="p",pch=19,cex=1.2,cex.lab=1.5,cex.main=1.5,
     xlab="Index (Each Observation)",ylab="Pii",main="Leverage Values (Pii)")
plot(1:n,cooki,type="p",pch=19,cex=1.2,cex.lab=1.5,cex.main=1.5,
     xlab="Index (Each Observation)",ylab="Cook's Distance",main="Influence Values (Cook's Distance)")
```



### Outliers in Y, Leverage and Influential Points


```{r}
plot(bodyfat2$BODYFAT, bodyfat2$WEIGHT)
plot(bodyfat2$BODYFAT, bodyfat2$ABDOMEN)
plot(bodyfat2$BODYFAT, bodyfat2$WRIST) #linearly correlated?
```
